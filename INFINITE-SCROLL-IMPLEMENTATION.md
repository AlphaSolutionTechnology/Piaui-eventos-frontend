# üöÄ Infinite Scroll - Implementa√ß√£o Completa

## üìã Resumo

Implementa√ß√£o de **pagina√ß√£o otimizada** e **infinite scroll** na p√°gina de eventos para melhor performance e experi√™ncia do usu√°rio.

---

## ‚úÖ Funcionalidades Implementadas

### 1. **Pagina√ß√£o Otimizada**

- ‚úÖ 20 eventos por p√°gina (aumentado de 12)
- ‚úÖ Pagina√ß√£o 0-indexed (compat√≠vel com Spring Boot)
- ‚úÖ Ordena√ß√£o por data descendente (mais recentes primeiro)
- ‚úÖ Metadados completos (totalPages, totalElements, first, last)

### 2. **Infinite Scroll**

- ‚úÖ Carregamento autom√°tico ao rolar 80% da p√°gina
- ‚úÖ Indicador visual "Carregando mais eventos..."
- ‚úÖ Mensagem de fim "Voc√™ viu todos os eventos!"
- ‚úÖ Preven√ß√£o de requisi√ß√µes duplicadas
- ‚úÖ Tratamento de erros com rollback de p√°gina

### 3. **Endpoint P√∫blico**

- ‚úÖ Sem autentica√ß√£o requerida
- ‚úÖ Removido `withCredentials: true`
- ‚úÖ Melhor SEO e compartilhamento

---

## üîß Mudan√ßas T√©cnicas

### **EventsService** (`src/app/services/events.service.ts`)

#### M√©todo `getEvents()` Atualizado

**Assinatura**:

```typescript
getEvents(
  filter?: EventsFilter,
  page: number = 0,
  size: number = 20,
  append: boolean = false  // ‚Üê NOVO par√¢metro
): Observable<EventsResponse>
```

**Par√¢metros**:

- `filter` - Filtros de busca (search, eventType)
- `page` - N√∫mero da p√°gina (0-indexed)
- `size` - Quantidade de eventos por p√°gina (padr√£o: 20)
- **`append`** - **NOVO**: Se `true`, adiciona eventos √† lista existente; se `false`, substitui

**Implementa√ß√£o**:

```typescript
getEvents(filter?, page = 0, size = 20, append = false): Observable<EventsResponse> {
  this.loadingSubject.next(true);
  this.errorSubject.next(null);

  let params = new HttpParams()
    .set('page', page.toString())
    .set('size', size.toString())
    .set('sort', 'eventDate,desc'); // Mais recentes primeiro

  if (filter?.search) {
    params = params.set('search', filter.search);
  }

  if (filter?.category) {
    params = params.set('eventType', filter.category);
  }

  // Endpoint P√öBLICO - sem withCredentials
  return this.http.get<SpringPageResponse<BackendEvent>>(this.apiUrl, { params })
    .pipe(
      map(response => this.transformBackendResponse(response)),
      tap(response => {
        // Se append=true, ADICIONA aos eventos existentes (infinite scroll)
        // Se append=false, SUBSTITUI os eventos (nova busca/filtro)
        const currentEvents = append ? this.eventsSubject.value : [];
        this.eventsSubject.next([...currentEvents, ...response.events]);
        this.loadingSubject.next(false);
      }),
      catchError(error => {
        console.error('Erro ao carregar eventos:', error);
        this.errorSubject.next('Erro ao carregar eventos. Tente novamente.');
        this.loadingSubject.next(false);
        return of({
          events: [],
          pagination: { page: 0, size, total: 0, totalPages: 0 },
          total: 0,
        });
      })
    );
}
```

**Mudan√ßas Chave**:

1. ‚úÖ Par√¢metro `append` controla se adiciona ou substitui eventos
2. ‚úÖ Ordena√ß√£o `eventDate,desc` (era `asc`)
3. ‚úÖ Size padr√£o aumentado para 20 (era 12)
4. ‚úÖ Removido `withCredentials: true` (endpoint p√∫blico)
5. ‚úÖ BehaviorSubject atualizado com l√≥gica append

---

### **EventsPage Component** (`src/app/pages/events-page/events-page.ts`)

#### Novas Propriedades

```typescript
// Pagina√ß√£o
currentPage = 0;
totalEvents = 0;
totalPages = 0; // ‚Üê NOVO: Total de p√°ginas dispon√≠veis
eventsPerPage = 20; // Aumentado de 12 para 20
hasMoreEvents = true; // ‚Üê NOVO: Indica se h√° mais p√°ginas
isLoadingMore = false; // ‚Üê NOVO: Loading espec√≠fico do infinite scroll
```

---

#### M√©todo `loadEvents()` Atualizado

Usado para **carregar a primeira p√°gina** ou **resetar** a lista:

```typescript
loadEvents(): void {
  const filters = {
    search: this.filters.name,
    eventType: this.filters.eventType,
    page: this.currentPage,
    limit: this.eventsPerPage,
  };

  // append=false: SUBSTITUI a lista de eventos
  this.eventsService
    .getEvents(filters, this.currentPage, this.eventsPerPage, false)
    .pipe(takeUntil(this.destroy$))
    .subscribe({
      next: (response) => {
        this.events = response.events;
        this.totalEvents = response.total;
        this.totalPages = response.pagination.totalPages;

        // Verifica se h√° mais p√°ginas dispon√≠veis
        this.hasMoreEvents = this.currentPage < response.pagination.totalPages - 1;

        this.applyFilters();
      },
      error: (error) => {
        this.error = 'Erro ao carregar eventos. Tente novamente.';
        console.error('Erro ao carregar eventos:', error);
      },
    });
}
```

---

#### M√©todo `loadMoreEvents()` - NOVO

Usado para **infinite scroll** (adicionar eventos):

```typescript
/**
 * Carrega mais eventos (infinite scroll)
 */
loadMoreEvents(): void {
  // Prote√ß√µes contra requisi√ß√µes duplicadas
  if (this.isLoadingMore || !this.hasMoreEvents || this.isLoading) {
    return;
  }

  this.isLoadingMore = true;
  this.currentPage++;

  const filters = {
    search: this.filters.name,
    eventType: this.filters.eventType,
    page: this.currentPage,
    limit: this.eventsPerPage,
  };

  // append=true: ADICIONA √† lista existente
  this.eventsService
    .getEvents(filters, this.currentPage, this.eventsPerPage, true)
    .pipe(takeUntil(this.destroy$))
    .subscribe({
      next: (response) => {
        // Adiciona novos eventos aos existentes
        this.events = [...this.events, ...response.events];
        this.totalEvents = response.total;
        this.totalPages = response.pagination.totalPages;
        this.hasMoreEvents = this.currentPage < response.pagination.totalPages - 1;
        this.isLoadingMore = false;
        this.applyFilters();
      },
      error: (error) => {
        console.error('Erro ao carregar mais eventos:', error);
        this.isLoadingMore = false;
        this.currentPage--; // Rollback da p√°gina em caso de erro
      },
    });
}
```

**L√≥gica de Prote√ß√£o**:

- `isLoadingMore`: Evita m√∫ltiplas requisi√ß√µes simult√¢neas
- `!hasMoreEvents`: N√£o carrega se j√° atingiu a √∫ltima p√°gina
- `isLoading`: N√£o carrega se ainda est√° carregando a primeira p√°gina

---

#### @HostListener('window:scroll') - NOVO

Detecta o scroll da p√°gina e dispara `loadMoreEvents()` automaticamente:

```typescript
/**
 * Detecta scroll para carregar mais eventos (infinite scroll)
 */
@HostListener('window:scroll')
onScroll(): void {
  // Prote√ß√µes
  if (this.isLoadingMore || !this.hasMoreEvents || this.isLoading) {
    return;
  }

  // Calcula posi√ß√µes
  const scrollPosition = window.pageYOffset + window.innerHeight;
  const pageHeight = document.documentElement.scrollHeight;

  // Threshold: 80% da p√°gina
  const threshold = pageHeight * 0.8;

  // Se passou de 80%, carrega mais
  if (scrollPosition >= threshold) {
    this.loadMoreEvents();
  }
}
```

**Como Funciona**:

1. Usu√°rio rola a p√°gina
2. Calcula: `posi√ß√£o atual + altura da janela`
3. Compara com: `80% da altura total`
4. Se passou de 80%, dispara `loadMoreEvents()`
5. Carrega pr√≥xima p√°gina (20 eventos)
6. Adiciona ao final da lista

**Configur√°vel**:

- Mudar `0.8` para `0.9` = carrega ao atingir 90%
- Mudar `0.8` para `0.5` = carrega ao atingir 50%

---

### **Template HTML** (`src/app/pages/events-page/events-page.html`)

#### Indicador de Loading (Infinite Scroll)

Mostrado **abaixo** da lista de eventos enquanto carrega mais:

```html
<!-- Indicador de Loading para Infinite Scroll -->
@if (isLoadingMore) {
<div class="loading-more-container">
  <div class="loading-spinner"></div>
  <p>Carregando mais eventos...</p>
</div>
}
```

---

#### Mensagem de Fim da Lista

Mostrada quando **n√£o h√° mais eventos** para carregar:

```html
<!-- Mensagem quando n√£o h√° mais eventos -->
@if (!hasMoreEvents && filteredEvents.length > 0 && !isLoading) {
<div class="end-of-list">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
    <path d="M8 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
  </svg>
  <p>Voc√™ viu todos os eventos dispon√≠veis!</p>
</div>
}
```

**Condi√ß√µes**:

- `!hasMoreEvents` - N√£o h√° mais p√°ginas
- `filteredEvents.length > 0` - H√° eventos na tela
- `!isLoading` - N√£o est√° carregando

---

### **Estilos CSS** (`src/app/pages/events-page/events-page.css`)

#### Loading More Container

```css
.loading-more-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 2rem;
  text-align: center;
  color: #6b7280;
  background: linear-gradient(180deg, transparent 0%, rgba(103, 126, 234, 0.05) 100%);
  border-radius: 16px;
  margin: 2rem auto;
  max-width: 400px;
}

.loading-more-container .loading-spinner {
  width: 32px;
  height: 32px;
  border-width: 2px;
}

.loading-more-container p {
  margin-top: 1rem;
  font-size: 0.875rem;
  font-weight: 500;
  color: #667eea;
}
```

---

#### End of List

```css
.end-of-list {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 2rem;
  text-align: center;
  color: #6b7280;
  background: linear-gradient(135deg, rgba(103, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
  border-radius: 16px;
  margin: 2rem auto;
  max-width: 400px;
  border: 1px solid rgba(103, 126, 234, 0.2);
}

.end-of-list svg {
  color: #667eea;
  margin-bottom: 1rem;
}

.end-of-list p {
  font-size: 0.9375rem;
  font-weight: 500;
  color: #667eea;
  margin: 0;
}
```

---

## üì° Endpoint da API

### **GET /api/events** (P√∫blico)

**Descri√ß√£o**: Retorna uma lista paginada de todos os eventos.

**Autentica√ß√£o**: ‚ùå N√£o requerida (endpoint p√∫blico)

**Query Params**:

```typescript
{
  page?: number;  // N√∫mero da p√°gina (0-indexed, default: 0)
  size?: number;  // Itens por p√°gina (default: 20)
  sort?: string;  // Ordena√ß√£o (default: "eventDate,desc")
}
```

**Exemplo de Requisi√ß√£o**:

```typescript
// Angular HttpClient
this.http.get('http://localhost:8080/api/events', {
  params: {
    page: '0',
    size: '20',
    sort: 'eventDate,desc',
  },
});
```

**Resposta (200 OK)**:

```json
{
  "content": [
    {
      "id": 1,
      "name": "Festival de M√∫sica 2025",
      "description": "Maior festival do estado do Piau√≠",
      "imageUrl": "https://example.com/imagem.jpg",
      "eventDate": "2025-12-15T20:00:00",
      "eventType": "Musical",
      "maxSubs": 500,
      "subscribersCount": 245,
      "eventLocation": {
        "id": 1,
        "placeName": "Arena Riverside",
        "fullAddress": "Avenida Frei Serafim, 2000",
        "zipCode": "64000000",
        "latitude": "-5.0920",
        "longitude": "-42.8034",
        "locationCategory": "Arena"
      },
      "version": 0
    }
    // ... mais 19 eventos
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 20
  },
  "totalPages": 5,
  "totalElements": 100,
  "last": false,
  "first": true,
  "numberOfElements": 20,
  "empty": false
}
```

**Metadados de Pagina√ß√£o**:

- `totalPages` - Total de p√°ginas dispon√≠veis
- `totalElements` - Total de eventos no sistema
- `first` - Se √© a primeira p√°gina
- `last` - Se √© a √∫ltima p√°gina
- `numberOfElements` - Quantidade de eventos nesta p√°gina

---

## üéØ Fluxo Completo

### **1. Carregamento Inicial**

```typescript
// Component ngOnInit()
this.loadEvents();

// Service getEvents(filters, page=0, size=20, append=false)
GET /api/events?page=0&size=20&sort=eventDate,desc

// Response
{ content: [20 eventos], totalPages: 5, totalElements: 95 }

// Component
this.events = [20 eventos]
this.currentPage = 0
this.totalPages = 5
this.hasMoreEvents = true (0 < 4)
```

---

### **2. Usu√°rio Rola a P√°gina**

```typescript
// @HostListener('window:scroll')
scrollPosition = 2400px
pageHeight = 3000px
threshold = 2400px (80% de 3000)

// scrollPosition >= threshold
this.loadMoreEvents();
```

---

### **3. Infinite Scroll**

```typescript
// loadMoreEvents()
this.isLoadingMore = true
this.currentPage++ // 0 ‚Üí 1

// Service getEvents(filters, page=1, size=20, append=true)
GET /api/events?page=1&size=20&sort=eventDate,desc

// Response
{ content: [20 eventos], totalPages: 5, totalElements: 95 }

// Component
this.events = [...40 eventos anteriores, ...20 novos]
this.currentPage = 1
this.hasMoreEvents = true (1 < 4)
this.isLoadingMore = false
```

---

### **4. √öltima P√°gina**

```typescript
// Usu√°rio continua rolando...
// currentPage = 3 ‚Üí 4

// Service getEvents(filters, page=4, size=20, append=true)
GET /api/events?page=4&size=20&sort=eventDate,desc

// Response
{ content: [15 eventos], totalPages: 5, totalElements: 95, last: true }

// Component
this.events = [...80 eventos, ...15 novos] // Total: 95
this.currentPage = 4
this.hasMoreEvents = false (4 < 4 √© false)

// Mostra mensagem "Voc√™ viu todos os eventos!"
```

---

## ‚úÖ Benef√≠cios

### **Performance**

- ‚úÖ Carrega apenas 20 eventos por vez (reduz payload)
- ‚úÖ Lazy loading (n√£o carrega tudo de uma vez)
- ‚úÖ Menor uso de mem√≥ria (100 eventos = 5 requisi√ß√µes)

### **UX (Experi√™ncia do Usu√°rio)**

- ‚úÖ Sem bot√£o "Carregar Mais" (autom√°tico)
- ‚úÖ Scroll infinito natural
- ‚úÖ Feedback visual claro (spinners e mensagens)
- ‚úÖ Sem quebras de experi√™ncia

### **SEO**

- ‚úÖ Endpoint p√∫blico (sem autentica√ß√£o)
- ‚úÖ Pode ser indexado por crawlers
- ‚úÖ Melhor compartilhamento em redes sociais

---

## üêõ Tratamento de Erros

### **Erro ao Carregar Mais**

```typescript
error: (error) => {
  console.error('Erro ao carregar mais eventos:', error);
  this.isLoadingMore = false;
  this.currentPage--; // ROLLBACK: Volta para p√°gina anterior
};
```

**Comportamento**:

1. Erro ocorre ao carregar p√°gina 2
2. `currentPage` volta de 2 para 1
3. Usu√°rio pode tentar novamente
4. `isLoadingMore = false` permite nova tentativa

---

### **Prote√ß√µes Contra Duplica√ß√£o**

```typescript
if (this.isLoadingMore || !this.hasMoreEvents || this.isLoading) {
  return; // Bloqueia requisi√ß√£o
}
```

**Evita**:

- ‚úÖ M√∫ltiplas requisi√ß√µes simult√¢neas
- ‚úÖ Carregar al√©m da √∫ltima p√°gina
- ‚úÖ Conflito com carregamento inicial

---

## üöÄ Como Testar

### **1. Iniciar Backend**

```bash
cd backend
./mvnw spring-boot:run
```

### **2. Iniciar Frontend**

```bash
npm start
```

### **3. Acessar P√°gina**

```
http://localhost:4200/events
```

### **4. Testar Infinite Scroll**

1. ‚úÖ Verifique que carrega 20 eventos inicialmente
2. ‚úÖ Role a p√°gina at√© 80%
3. ‚úÖ Veja o spinner "Carregando mais eventos..."
4. ‚úÖ Novos 20 eventos aparecem automaticamente
5. ‚úÖ Repita at√© ver "Voc√™ viu todos os eventos!"

### **5. Verificar Network Tab**

Abra DevTools ‚Üí Network ‚Üí XHR:

```
GET /api/events?page=0&size=20&sort=eventDate,desc  ‚Üí 200 OK (20 eventos)
GET /api/events?page=1&size=20&sort=eventDate,desc  ‚Üí 200 OK (20 eventos)
GET /api/events?page=2&size=20&sort=eventDate,desc  ‚Üí 200 OK (20 eventos)
...
```

---

## üìù Configura√ß√µes Personaliz√°veis

### **Alterar Quantidade por P√°gina**

```typescript
// events-page.ts
eventsPerPage = 30; // Era 20
```

### **Alterar Threshold do Scroll**

```typescript
// events-page.ts ‚Üí onScroll()
const threshold = pageHeight * 0.9; // 90% em vez de 80%
```

### **Alterar Ordena√ß√£o**

```typescript
// events.service.ts ‚Üí getEvents()
.set('sort', 'eventDate,asc'); // Mais antigos primeiro
.set('sort', 'name,asc');       // Alfab√©tica A-Z
```

---

## üéâ Conclus√£o

**Infinite scroll implementado com sucesso!** üöÄ

‚úÖ Pagina√ß√£o otimizada (20 por p√°gina)  
‚úÖ Carregamento autom√°tico ao rolar  
‚úÖ Indicadores visuais claros  
‚úÖ Tratamento de erros robusto  
‚úÖ Endpoint p√∫blico (sem autentica√ß√£o)  
‚úÖ Performance melhorada

**Pronto para produ√ß√£o!** üéä
