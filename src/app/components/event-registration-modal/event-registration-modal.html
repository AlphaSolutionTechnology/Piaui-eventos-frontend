@if (isOpen) {
<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Success Message -->
    @if (showSuccess) {
    <div class="success-modal">
      <div class="success-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
          <path
            d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>
      <h3>{{ isUserSubscribed ? 'Inscrição Cancelada!' : 'Inscrição Confirmada!' }}</h3>
      <p>
        {{
          isUserSubscribed
            ? 'Sua inscrição foi cancelada.'
            : 'Sua participação foi confirmada com sucesso.'
        }}
      </p>
      <p class="redirect-text">Redirecionando...</p>
    </div>
    }

    <!-- Unsubscribe Confirmation Pop-up -->
    @if (showConfirmUnsubscribe && !showSuccess) {
    <div class="unsubscribe-confirmation">
      <div class="confirmation-overlay" (click)="cancelUnsubscribe()"></div>
      <div class="confirmation-dialog">
        <h3>Cancelar Inscrição</h3>
        <p>Tem certeza que deseja cancelar sua inscrição neste evento?</p>
        <div class="confirmation-actions">
          <button
            type="button"
            class="btn-cancel"
            (click)="cancelUnsubscribe()"
            [disabled]="isLoading"
          >
            Manter Inscrição
          </button>
          <button
            type="button"
            class="btn-confirm danger"
            (click)="onConfirmUnsubscribe()"
            [disabled]="isLoading"
            [class.loading]="isLoading"
          >
            @if (!isLoading) {
            <span>Confirmar Cancelamento</span>
            } @else {
            <span class="loading-text">
              <div class="spinner"></div>
              Processando...
            </span>
            }
          </button>
        </div>
      </div>
    </div>
    }

    <!-- Registration Form -->
    @if (!showSuccess) {
    <div class="registration-content">
      <!-- Header -->
      <div class="modal-header">
        <div class="header-content">
          <h2>{{ isUserSubscribed ? 'Gerenciar Inscrição' : 'Confirmar Participação' }}</h2>
          <p class="event-name">{{ eventName }}</p>
        </div>
        <button class="close-btn" (click)="closeModal()" type="button">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <line
              x1="18"
              y1="6"
              x2="6"
              y2="18"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
            <line
              x1="6"
              y1="6"
              x2="18"
              y2="18"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>
      </div>

      <!-- User Information (Read-only) -->
      @if (currentUser && !isUserSubscribed) {
      <div class="user-info-section">
        <h3>Informações de Participação</h3>
        <div class="info-grid">
          <div class="info-item">
            <label>Nome</label>
            <p class="info-value">{{ currentUser.name }}</p>
          </div>
          <div class="info-item">
            <label>E-mail</label>
            <p class="info-value">{{ currentUser.email }}</p>
          </div>
          <div class="info-item">
            <label>Telefone</label>
            <p class="info-value">{{ formatPhoneNumber(currentUser.phoneNumber) }}</p>
          </div>
        </div>
        <p class="info-note">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
            <line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2" />
            <line x1="12" y1="16" x2="12.01" y2="16" stroke="currentColor" stroke-width="2" />
          </svg>
          Estes dados foram preenchidos durante seu cadastro.
        </p>
      </div>
      }

      <!-- Already Subscribed Info -->
      @if (currentUser && isUserSubscribed) {
      <div class="user-info-section subscribed">
        <div class="subscribed-status">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path
              d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <p>Você já está inscrito neste evento</p>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <label>Nome</label>
            <p class="info-value">{{ currentUser.name }}</p>
          </div>
          <div class="info-item">
            <label>E-mail</label>
            <p class="info-value">{{ currentUser.email }}</p>
          </div>
          <div class="info-item">
            <label>Telefone</label>
            <p class="info-value">{{ formatPhoneNumber(currentUser.phoneNumber) }}</p>
          </div>
        </div>
      </div>
      }

      <!-- Additional Information Form - Only for New Registration -->
      @if (!isUserSubscribed) {
      <form class="registration-form">
        <div class="form-section">
          <h3>Informações Adicionais</h3>

          <div class="form-group">
            <label for="dietary">Restrições Alimentares (opcional)</label>
            <input
              type="text"
              id="dietary"
              [(ngModel)]="dietaryRestrictions"
              name="dietaryRestrictions"
              placeholder="Ex: Vegetariano, intolerância à lactose, etc."
              class="form-input"
            />
          </div>

          <div class="form-group">
            <label for="comments">Comentários (opcional)</label>
            <textarea
              id="comments"
              [(ngModel)]="comments"
              name="comments"
              rows="3"
              placeholder="Alguma observação ou pergunta?"
              class="form-textarea"
            ></textarea>
          </div>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="receiveUpdates"
                name="receiveUpdates"
                class="checkbox-input"
              />
              <span class="checkmark"></span>
              Desejo receber atualizações sobre este evento
            </label>
          </div>
        </div>

        <!-- Terms Agreement -->
        <div class="form-section terms-section">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [(ngModel)]="agreeTerms"
              name="agreeTerms"
              class="checkbox-input"
              required
            />
            <span class="checkmark"></span>
            Confirmo minha participação neste evento e aceito os
            <a href="#" class="terms-link">termos e condições</a> *
          </label>
        </div>

        <!-- Error Alert -->
        @if (showError) {
        <div class="error-alert" [class.show]="showError">
          <div class="error-content">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
              <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2" />
              <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2" />
            </svg>
            <span>{{ errorMessage }}</span>
          </div>
        </div>
        }

        <!-- Form Actions - Registration Mode -->
        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="closeModal()" [disabled]="isLoading">
            Cancelar
          </button>
          <button
            type="button"
            class="btn-confirm primary"
            (click)="onConfirmRegistration()"
            [disabled]="isLoading"
            [class.loading]="isLoading"
          >
            @if (!isLoading) {
            <span>Confirmar Inscrição</span>
            } @else {
            <span class="loading-text">
              <div class="spinner"></div>
              Processando...
            </span>
            }
          </button>
        </div>
      </form>
      }

      <!-- Already Subscribed Actions - Only for Existing Subscriptions -->
      @if (isUserSubscribed) {
      <form class="registration-form">
        <!-- Error Alert -->
        @if (showError) {
        <div class="error-alert" [class.show]="showError">
          <div class="error-content">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
              <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2" />
              <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2" />
            </svg>
            <span>{{ errorMessage }}</span>
          </div>
        </div>
        }

        <!-- Form Actions - Unsubscribe Mode -->
        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="closeModal()" [disabled]="isLoading">
            Manter Inscrição
          </button>
          <button
            type="button"
            class="btn-confirm danger"
            (click)="showUnsubscribeConfirmation()"
            [disabled]="isLoading"
          >
            Cancelar Inscrição
          </button>
        </div>
      </form>
      }
    </div>
    }
  </div>
</div>
}
